<HTML>
<HEAD>
<TITLE></TITLE>
<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="TEXT/HTML; CHARSET=WINDOWS-1251">
</HEAD>
<body background="../fon.jpg">

<p><CENTER><font size="4"><b>ГЛАВА 20
<br>
Многопользовательская работа в локальной сети </b></font>
</center>
</P>
<br>
<br>

<ul>
  <li><a href="gl20.html#1">Типы блокировок</a>
  <li><a href="gl20.html#2">Автоматическая блокировка</a>
  <li><a href="gl20.html#3">Полная блокировка таблицы и блокировка изменений</a>
  <li><a href="gl20.html#4">Блокировка таблицы</a>
  <li><a href="gl20.html#5">Блокировка записей</a>
  <li><a href="gl20.html#6">Установка режима повторных попыток блокировки данных</a>
  <li><a href="gl20.html#7">Снятие блокировок таблиц и записей</a>
  <li><a href="gl20.html#8">Сеансы работы с данными</a>
  <li><a href="gl20.html#9">Использование буферов</a>
  <li><a href="gl20.html#10">Блокировка при буферизации</a>
  <li><a href="gl20.html#11">Обнаружение и устранение конфликтов</a>
  <li><a href="gl20.html#12">Использование транзакций</a>
</ul>

<P>
В однопользовательской системе с данными работает только один человек, и ему нет необходимости думать о разделении доступа к файлам. Однако, с появлением пользователей, желающих получить доступ к одним и тем же данным, планирование разделения доступа к базе становится актуальным. 
</P>
<P>
В многопользовательских приложениях необходимо обеспечить доступ к данным тем пользователям, которым он действительно нужен. При разработке сетевых приложений по управлению базами данных необходимо предусмотреть разрешение конфликтов, возникающих при попытке двух и более пользователей одновременно изменить одни и те же данные. Visual FoxPro предлагает несколько вариантов решения этой проблемы, позволяя пользователю использовать перед изменением таблиц или записей автоматические или ручные методы их блокировки. При доступе к записям таблицы 
блокировка запрещает кому-либо изменять заблокированную область, пока пользователь не завершит свои изменения и не разблокирует эти данные. 
</P>
<P>
Эта глава ознакомит вас с концепциями разделения данных в сетевой среде и организацией интерфейса при совместной работе нескольких пользователей. 
</P>
<p>&nbsp;
<a NAME="1"></a><font size="4">Типы блокировок </font> 
</P>
<P>
В Vi&amp;ual FoxPro вы можете использовать два типа блокировок: блокировку таблицы и записи. Блокировка таблицы запрещает доступ другим пользователям ко всей таблице, пока вы редактируете одну или несколько записей. Применение блокировки записи не допускает изменения записи кем-либо, кроме пользователя, установившего блокировку. 
</P>
<P>
По возможности следует использовать блокировку записи, потому что она запрещает изменение только одной записи, а не всей таблицы. Например, пока вы редактируете запись о покупателе Иванове, кто-нибудь может работать 
с записью о покупателе Петрове. И вы оба можете совершать изменения, не мешая друг другу и не беспокоясь за действия другого. 
</P>
<p>&nbsp;
<a NAME="2"></a><font size="4">Автоматическая блокировка </font> 
</P>
<P>
В Visual FoxPro может осуществляться автоматическая или ручная блокировка данных. При использовании определенных команд FoxPro попытается автоматически заблокировать записи или всю таблицу (табл. 20.1). 
</P>
<P>
Таблица 20.1. Команды, автоматически блокирующие таблицу или записи 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Команда 
</TD>
<TD VALIGN="TOP">
Что блокируется 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
ALTER   TABLE 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
APPEND 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
APPEND   BLANK 
</TD>
<TD VALIGN="TOP">
Заголовок таблицы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
APPEND   FROM 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
APPEND   FROM  ARRAY 
</TD>
<TD VALIGN="TOP">
Заголовок таблицы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
APPEND   MEMO 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
BLANK 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
BROWSE 
</TD>
<TD VALIGN="TOP">
Текущая запись и все записи из одноименных полей в связанных таблицах 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
CHANGE 
</TD>
<TD VALIGN="TOP">
Текущая запись и все записи из одноименных полей в связанных таблицах 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
DELETE 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
DELETE   NEXT   1 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
DELETE   &lt;n&gt; 
</TD>
<TD VALIGN="TOP">
Если л больше 1 , автоматически блокируется вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
DELETE   RECORD   &lt;n&gt; 
</TD>
<TD VALIGN="TOP">
Автоматически блокирует п записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
DELETE   SQL 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
EDIT 
</TD>
<TD VALIGN="TOP">
Текущая запись и все записи из одноименных полей в связанных таблицах 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
GATHER 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
INSERT 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
INSERT   SQL 
</TD>
<TD VALIGN="TOP">
Заголовок таблицы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
MODIFY   MEMO 
</TD>
<TD VALIGN="TOP">
Когда начинается редактирование записи, автоматически блокирует ее 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
READ 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
RECALL 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
RECALL   NEXT   1 
</TD>
<TD VALIGN="TOP">
Автоматически блокирует указанную запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
RECALL   RECORD   &lt;n&gt; 
</TD>
<TD VALIGN="TOP">
Блокирует п записей 
</TD>
</TR>

<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
RECALL   &lt;n&gt; 
</TD>
<TD VALIGN="TOP">
Если п больше 1 , автоматически блокируется вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
REPLACE 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
REPLACE   NEXT   1 
</TD>
<TD VALIGN="TOP">
Автоматически блокирует указанную запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
REPLACE  RECORD   &lt;n&gt; 
</TD>
<TD VALIGN="TOP">
Блокирует п записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
SHOW  GETS 
</TD>
<TD VALIGN="TOP">
Текущая запись 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
TABLEUPDATEO 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
UPDATE 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
UPDATE   SQL 
</TD>
<TD VALIGN="TOP">
Вся таблица 
</TD>
</TR>
</TABLE>
<P>
<font color="#008000"><b>Замечание</b></font></P>
<P>
<font color="#008000">Все команды с автоматической блокировкой снимают ее после выполнения.
</font> 
</P>
<p>&nbsp;
<a NAME="3"></a><font size="4">Полная блокировка таблицы и блокировка изменений </font> 
</P>
<P>
В некоторых случаях, например, при изменении структуры данных, вам необходимо осуществить полную блокировку таблицы для получения исключительных прав на нее. В этом случае другим пользователям запрещается чтение, запись и изменение структуры указанной таблицы, и они не смогут получить к ней доступ. Вы не можете установить полную блокировку, если эта таблица уже открыта или для нее уже установлена блокировка. 
</P>
<P>
В большинстве случаев вам достаточно ограничить изменение данных таблицы, т. е. 
установить блокировку изменений, которая запрещает запись, изменение структуры 
указанной таблицы, наложение блокировки изменений другими пользователями. 
</P>
<P>
Для открытия таблицы в режиме полной блокировки используется команда SET EXCLUSIVE ON. После выполнения данной команды все открываемые таблицы будут находиться в режиме полной блокировки. Для снятия режима полной блокировки используйте команду SET EXCLUSIVE OFF. При этом полная блокировка открытых таблиц будет снята только после их закрытия. Для установки полной блокировки отдельной таблицы может быть использована опция EXCLUSIVE в команде открытия таблицы USE. Если таблица открыта в монопольном режиме, необходимость блокировки таблицы или ее записей отсутствует. После закрытия таблицы блокировка автоматически снимается. 
</P>
<P>
Ниже приведены два примера установки полной блокировки таблицы. В первом примере 
используются две команды, а во втором — таблица открывается в режиме исключительного использования одной командой: 
</P>
<blockquote>
<P>
 SET EXLUSIVE ON 
</P>
<P>
 USE CUSTOMER 
</P>
</blockquote>
<P>
 или</P>
<blockquote>
<P>
 USE CUSTOMER EXCLUSIVE 
</P>
</blockquote>
<P>
Некоторые команды, список которых приведен ниже, могут использоваться только в режиме полной блокировки: 
</P>
<ul>
  <li>ALTER TABLE </li>
  <li>INDEX </li>
  <li>INSERT [BLANK] </li>
  <li>MODIFY STRUCURE </li>
  <li>PACK </li>
  <li>REINDEX </li>
  <li>ZAP </li>
</ul>
<P>
Если вы попробуете применить одну из этих команд, не открыв таблицу для исключительного использования, FoxPro выдаст предупреждающее сообщение Exclusive Open of File Required. 
</P>
<p>&nbsp;
<a NAME="4"></a><font size="4">Блокировка таблицы </font> 
</P>
<P>
Для установки блокировки изменений таблицы вы должны использовать функцию FLOCK, которая имеет следующий синтаксис: 
</P>
<blockquote>
<P>
 FLOCK([псевдонимТаблицы]) 
</P>
</blockquote>
<P>
Функция блокировки проверяет текущий статус таблицы. Если в результате теста определяется, что таблица не заблокирована, она блокируется, и пользователь может продолжать с ней работать. Функция при этом возвращает логическое значение .т. (Истина) и таблица становится доступной пользователю, выполнившему блокировку, на чтение и запись. Остальным пользователям таблица базы данных доступна только на чтение. Если таблица уже заблокирована другим пользователем, заблокировать таблицу не удается и функция возвращает значение .F. (Ложь). Для блокировки таблицы в текущей области псевдоним можно не указывать. 
</P>
<P>
В приведенном ниже примере для блокировки таблицы customer используется команда FLOCK (). Если таблица успешно заблокирована, команда
REPLACE   ALL обновляет все записи в ней. После этого команда UNLOCK снимает блокировку файла. Если файл невозможно заблокировать (такая ситуация возникает, если файл уже заблокирован другим пользователем), появится сообщение об ошибке. 
</P>
<blockquote>
<P>
 SET EXCLUSIVE OFF 
</P>
<P>
 SET REPROCESS TO 0  
</P>
<P>
 USE Customer  
</P>
<P>
 IF FLOCK() 
</P>
<P>
 REPLACE ALL cLastName WITH UPPER(cLastName)  
</P>
<P>
 UNLOCK 
</P>
<P>
 ELSE 
</P>
<P>
 WAIT &quot;Файл занят, подождите&quot; WINDOW NOWAIT 
</P>
<P>
 ENDIF 
</P>
</blockquote>
<P>
Если вы редактируете две или более связанных командой SET RELATION таблиц, вам необходимо блокировать каждую связанную таблицу самостоятельно, т. к. блокировка одной из связанных таблиц не блокирует связанные с ней таблицы. Возможны ситуации, когда вы изменяете данные только в одной таблице, а другие используются для отображения дополнительной информации и их не требуется блокировать. 
</P>
<p>&nbsp;
<a NAME="5"></a><font size="4">Блокировка записей </font> 
</P>
<P>
По возможности рекомендуется использовать блокировку отдельных записей, а не таблицы в целом. Заблокированная запись может изменяться только установившим блокировку пользователем, остальные пользователи имеют к ней доступ только на чтение. Результат изменения записи будет виден другим пользователям только после снятия блокировки с записи. 
</P>
<P>
Для блокировки записей используются взаимозаменяемые функции LOCK и RLOCK, синтаксис которых отличается только наименованием функции: 
</P>
<blockquote>
<P>
RLOCK([  рабочаяОбласть   |   псевдонимТаблицы]</P>
<P>
<span lang="en-us">| </span>[номераЗаписей,   рабочаяОбласть 
</P>
<P>
|   псевдонимТаблицы]) 
</P>
</blockquote>
<P>
Для указания таблицы, записи которой вы собираетесь блокировать, можно 
использовать номер рабочей области или псевдоним таблицы. Если не указаны ни рабочая область, ни псевдоним, функция LOCK будет блокировать текущую запись таблицы, открытой в рабочей области. 
</P>
<P>
Для блокировки группы записей предварительно выполните команду SET MULTILOCKS ON и с помощью аргумента номера<span lang="en-us">
</span>Записей укажите номера блокируемых записей. Номера записей задаются в символьном виде и разделяются запятыми. Например, для блокировки третьей и пятой записи таблицы необходимо указать &quot;3, 5&quot;. 
</P>
<P>
<font color="#008000"><b>Замечание</b></font></P>
<P>
<font color="#008000">Для определения номеров записей используйте функцию RECNO ().
</font> 
</P>
<P>
При успешной блокировке возвращается значение .т. (Истина) и заблокированные записи становятся доступными на чтение и запись пользователю, установившему блокировку. Остальные пользователи могут только просматривать заблокированные записи. При блокировке группы записей функция возвращает значение .т. (Истина) только в том случае, если удалось заблокировать все указанные записи. Тем не менее, записи, которые удалось блокировать, останутся заблокированными. 
</P>
<P>
Если запись или таблица уже заблокированы другим пользователем, блокировка не будет выполнена и функция возвратит значение . F. (Ложь). 
</P>
<P>
<font color="#800000"><b>Совет</b></font></P>
<P>
<font color="#800000">Для блокировки группы записей вы можете поочередно 
устанавливать указатель записи на блокируемую запись и выполнять команду LOCK.
</font> 
</P>
<P>
Для выбора режима блокировки одной или группы записей используется команда SET MULTiLOCKS, которая 'имеет следующий синтаксис: 
</P>
<blockquote>
<P>
SET  MULTILOCKS  ON <span lang="en-us">|</span>   OFF 
</P>
</blockquote>
<P>
Параметр ON разрешает блокировку группы записей, а параметр OFF разрешает блокировку только одной записи. 
</P>
<P>
<font color="#008000"><b>Замечание</b></font></P>
<P>
<font color="#008000">Переключение установки MULTILOCKS из ON в OFF, или из OFF в ON приводит к снятию блокировки со всех записей во всех открытых таблицах.
</font> 
</P>
<p>&nbsp;
<a NAME="6"></a><font size="4">Установка режима повторных попыток блокировки данных </font> 
</P>
<P>
Если запись или таблица уже заблокированы, вам не удастся с первого раза установить блокировку. В этом случае вы можете использовать команду SET REPROCESS, которая задает количество дополнительных попыток заблокировать таблицу (или запись) или время, на протяжении которого будут выполняться дополнительные попытки блокировки. 
</P>
<P>
Команда SET REPROCESS имеет следующий синтаксис: 
</P>
<blockquote>
<P>
 SET REPROCESS ТО числоПопьггок [SECONDS] I TO AUTOMATIC 
</P>
</blockquote>
<P>
Если команда содержит опцию SECONDS, аргумент число<span lang="en-us"> </span>попыток задает время в секундах, иначе — количество попыток. Аргумент число попыток может
принимать целые значения в диапазоне от 1 до 32 000, по умолчанию его значение равно 0. 
</P>
<P>
При использовании параметра то AUTOMATIC, а также, если значение аргумента число попыток равно 0, Visual FoxPro будет пытаться выполнить блокировку записи или таблицы до бесконечности. Во время выполнения попыток блокировки будет выводиться сообщение о том, что идет процесс блокировки. Пользователь может прервать процесс установки блокировки нажатием клавиши &lt;Esc&gt;. 
</P>
<P>
При установке SET REPROCESS то -i Visual FoxPro также будет пытаться выполнить блокировку записи или таблицы до бесконечности. Но в этом случае пользователь не может прервать попытки заблокировать запись или таблицу. 
</P>
<P>
<font color="#008000"><b>Замечание</b></font></P>
<P>
<font color="#008000">Успешная блокировка записи или таблицы, уже заблокированной другим пользователем, возможна только после того, как пользователь, установивший блокировку, 
снимет ее. Поэтому рекомендуется снимать блокировку сразу же после завершения операции, для выполнения которой требовалась блокировка.
</font> 
</P>
<p>&nbsp;
<a NAME="7"></a><font size="4">Снятие блокировок таблиц и записей </font> 
</P>
<P>
В большинстве случаев при переходе от одной записи к другой блокировка снимается. Однако, если вы заблокировали запись командами блокировки, ее необходимо разблокировать, чтобы к ней могли получить доступ другие пользователи. В табл. 20.2 описаны команды, используемые для снятия блокировок. 
</P>
<P>
Таблица 20.2. Команды снятия блокировки с записей и таблиц 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Команда 
</TD>
<TD VALIGN="TOP">
Описание 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
CLOSE 
</TD>
<TD VALIGN="TOP">
Снимает асе блокировки с записей и таблиц 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
CLOSE   ALL 
</TD>
<TD VALIGN="TOP">
Снимает все блокировки с записей и таблиц 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
END  TRANSACTION 
</TD>
<TD VALIGN="TOP">
Снимает все автоматически установленные блокировки 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
QUIT 
</TD>
<TD VALIGN="TOP">
Снимает все блокировки с записей и таблиц 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
UNLOCK 
</TD>
<TD VALIGN="TOP">
Снимает все блокировки с записей и таблиц в текущей рабочей области 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
UNLOCK  ALL 
</TD>
<TD VALIGN="TOP">
Снимает все блокировки с записей и таблиц во всех рабочих областях 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
USE 
</TD>
<TD VALIGN="TOP">
Снимает все блокировки с записей и таблицы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
SET  MULTILOCKS OFF 
</TD>
<TD VALIGN="TOP">
Позволяет автоматическое  снятие  текущей  блокировки   при создании новой 
</TD>
</TR>

<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
FLOCK ( ) 
</TD>
<TD VALIGN="TOP">
Перед блокировкой файла снимает все блокировки находящихся в нем записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
TABLEUPDATE ( ) 
</TD>
<TD VALIGN="TOP">
Прежде чем обновить таблицу, снимает все блокировки 
</TD>
</TR>
</TABLE>
<P>
Наиболее часто для снятия блокировок с таблиц и записей используется команда UNLOCK, которая имеет следующий синтаксис: 
</P>
<blockquote>
<P>
 UNLOCK [RECORD номерЗаписи] [IN &lt; псевдонимТаблицы &gt;] [ALL] 
</P>
</blockquote>
<P>
Команда UNLOCK без параметров сбрасывает блокировку с текущей записи или таблицы. 
</P>
<P>
При снятии блокировки с таблицы опция RECORD не используется, задается только 
псевдоним таблицы. Если псевдоним не указан, снимается блокировка с текущей таблицы. Для разблокировки всех открытых таблиц используется параметр ALL. Для снятия блокировки с записи укажите параметр RECORD и номер записи. 
</P>
<P>
<font color="#008000"><b>Замечание</b></font></P>
<P>
<font color="#008000">Блокировка записи или таблицы может сниматься только пользователем, установившим данную блокировку. Таблицы, открытые в режиме полной блокировки, с помощью команды UNLOCK разблокировать нельзя.
</font> 
</P>
<p>&nbsp;
<a NAME="8"></a><font size="4">Сеансы работы с данными </font> 
</P>
<P>
В Visual FoxPro для многопользовательской работы вы можете использовать сеансы 
работы с данными, которые представляют из себя среду окружения, связанную с 
формой или набором форм. С помощью сеансов работы с данными вы можете открывать одну и ту же форму на разных рабочих станциях или даже на одном компьютере (рис. 20.1), при этом каждая из них будет использовать отдельную копию данных. 
</P>
<P>
Для управления сеансом работы с данными предназначено свойство DataSession (Окно данных) формы, которое можно установить равным 1 или 2. Если вы установите свойство DataSession равным 1, любые изменения, выполненные вами в форме, будут отображаться во всех остальных открытых формах. Это обычный режим работы. Дня открытия копии среды окружения установите значение 2, при этом изменения в данной форме не будут отображаться в других формах. Количество открытых сеансов ограничивается только доступной оперативной памятью и местом на жестком диске. 
</P>
<IMG src="gl20-1.jpg" alt="gl20-1.jpg" width="500" height="454" ></IMG>
<P>
Рис. 20.1. Открытие сеансов работы на одном компьютере 
</P>
<IMG src="gl20-2.jpg" alt="gl20-2.jpg" width="500" height="454" ></IMG>
<P>
Рис. 20.2. Выбор сеанса работы 
</P>
<P>
Для выбора сеанса работы вы можете выполнить любое из следующих действий. 
</P>
<ul>
  <li>Открыть окно Data Session (Окно данных) и из раскрывающегося списка Current session (Текущий сеанс) выбрать требуемый сеанс работы (рис. 20.2). 
  </li>
  <li>Выполнить в командном окне команду SET DATASESSION ТО номерСеанса. </li>
</ul>
<p>&nbsp;
<a NAME="9"></a><font size="4">Использование буферов </font> 
</P>
<P>
Одним из мощных средств организации многопользовательской работы в Visual FoxPro является буферизация данных, которая позволяет лучше использовать локальные ресурсы и снижает нагрузку на сеть. При буферизации все сделанные вами изменения хранятся в оперативной памяти на рабочей станции и не обновляются на файл-сервере, пока вы не выполните соответствующую команду. 
</P>
<P>
В Visual FoxPro используются два типа буферизации: буферизация таблиц и записей. При буферизации записей после завершения редактирования записи (при изменении позиции указателя записи или при вызове функции TABLEUPDATE), все изменения записываются в базу данных. При буферизации 
таблиц измененные данные' сохраняются в базе данных только при закрытии таблицы или вызове функции TABLEUPDATE (}. 
</P>
<p>&nbsp;
<a NAME="10"></a><font size="4">Блокировка при буферизации </font> 
</P>
<P>
В Visual FoxPro вы можете выбрать пессимистический и оптимистический режимы 
буферизации, которые определяют, как и когда будет осуществляться блокировка данных. В зависимости от типа решаемых задач, вы можете выбрать один из типов буферизации данных (табл. 20.3). 
</P>
<P>
Таблица 20.3. Типы буферизации данных 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Значение 
</TD>
<TD VALIGN="TOP">
Описание 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
1 
</TD>
<TD VALIGN="TOP">
Буферы не используются 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
2 
</TD>
<TD VALIGN="TOP">
Пессимистическая блокировка записей. Visual FoxPro блокирует запись сразу же 
после начала редактирования данных и освобождает блокировку только после перехода на следующую запись или при выполнении фуНКЦИИ TABLEUPDATE ( ) 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
3 
</TD>
<TD VALIGN="TOP">
Оптимистическая блокировка записей. Позволяет редактировать текущую запись в других сеансах работы и блокирует запись только при переходе на следующую запись или выполнении функции TABLEUPDATE ( } 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
4 
</TD>
<TD VALIGN="TOP">
Пессимистическая блокировка таблицы. Блокируются все редактируемые записи, но их обновление в базе данных осуществляется только 
при вызове функции TABLEUPDATE ( ) 
</TD>
</TR>

<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
5 
</TD>
<TD VALIGN="TOP">
Оптимистическая блокировка таблицы. Позволяет редактировать записи в других сеансах работы и блокирует записи только при обновлении записей в базе данных с помощью функции TABLEUPDATE ( ) 
</TD>
</TR>
</TABLE>
<P>
При выборе любого типа буферизации данных вы можете отказаться от выполненных изменений с помощью функции TABLEREVERT (). 
</P>
<P>
Для   установки   типа   буферизации   вы   можете   использовать   функцию
 CURSORSETPROPO,    свойство BufferMode    формы и свойство
BufferModeOverride курсора, используемого в среде окружения формы. 
</P>
<P>
Свойство BufferMode формы может принимать одно из значений, описанных в табл. 20.4. 
</P>
<P>
Таблица 20.4. Значения свойства BufferMode 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Значение 
</TD>
<TD VALIGN="TOP">
Описание 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
0 
</TD>
<TD VALIGN="TOP">
Записи блокируются с момента начала редактирования, и значения полей записываются в базу данных при переходе к следующей записи 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
1 
</TD>
<TD VALIGN="TOP">
Пессимистическая блокировка записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
2 
</TD>
<TD VALIGN="TOP">
Оптимистическая блокировка записей 
</TD>
</TR>
</TABLE>
<P>
Для определения свойства Buf ferModeOverride откройте окно конструктора формы, выполните команду Data Environment (Среда окружения) из меню View (Вид). Далее в окне Data Environment (Среда окружения) выберите таблицу, 
нажмите правую кнопку мыши и из контекстного меню выберите команду Properties (Свойства). Откроется окно свойств, в котором выберите свойство BufferModeOverride (рис. 20.3) и установите одно из возможных значений (табл. 20.5). 
</P>
<P>
Таблица 20.5. Значения свойства BufferModeOverride 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Значение 
</TD>
<TD VALIGN="TOP">
Описание 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
0 
</TD>
<TD VALIGN="TOP">
Буферы не используются 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
1 
</TD>
<TD VALIGN="TOP">
Использует тип блокировки, заданный свойством BufferMode формы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
2 
</TD>
<TD VALIGN="TOP">
Пессимистическая блокировка записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
3 
</TD>
<TD VALIGN="TOP">
Оптимистическая блокировка записей 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
4 
</TD>
<TD VALIGN="TOP">
Пессимистическая блокировка таблицы 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
5 
</TD>
<TD VALIGN="TOP">
Оптимистическая блокировка таблицы 
</TD>
</TR>
</TABLE>
&nbsp;<p>
<IMG src="gl20-3.jpg" alt="gl20-3.jpg" width="500" height="454" ></IMG> </p>
<P>
Рис. 20.3. Определение значения свойства BufferModeOverride  курсора 
</P>
<IMG src="gl20-4.jpg" alt="gl20-4.jpg" width="342" height="288" ></IMG>
<P>
Рис. 20.4. Определение типа блокировки в диалоговом окне Work Area Properties 
</P>
<P>
Функция CURSORSETPROP (), используемая для определения типа буферизации курсора, имеет следующий синтаксис: 
</P>
<blockquote>
<P>
 CURSORSETPROP(Buffaring, типБуферизации, 
</P>
<P>
 псевдонимТаблицы | номерРабочейОбласти]) 
</P>
</blockquote>
<P>
Для  определения  текущего типа  буферизации   воспользуйтесь свойством
BufferModeOverride курсора или функцией CURSORGETPROP() . 
</P>
<P>
При работе в интерактивном режиме вы можете установить тип блокировки в диалоговом окне Work Area Properies (Свойства рабочего пространства) (рис. 20.4), которое открывается при нажатии кнопки Properties (Свойства) в диалоговом окне Data Session (Данные сеанса), 
</P>
<p>&nbsp;
<a NAME="11"></a><font size="4">Обнаружение и устранение конфликтов </font> 
</P>
<P>
При совместной работе с базой данных возможны конфликты, когда один или более пользователей пытаются заблокировать уже заблокированную другим пользователем запись. Возможны и взаимоблокировки, когда пользователь 
заблокировал одну запись или таблицу и пытается заблокировать вторую, которая 
уже заблокирована вторым пользователем. В то же время второй пользователь 
пытается заблокировать запись, заблокированную первым пользователем. Система буферизации записей и таблиц FoxPro упрощает 
разработку многопользовательских приложений и устранение возникающих конфликтов. 
</P>
<P>
При попытке заблокировать уже заблокированную запись FoxPro выдает сообщение об ошибке. Для определения возникновения ошибки вы можете воспользоваться функцией TABLEUPDATE (), которая возвращает значение . F. (Ложь) при неудачной попытке сохранения данных. Кроме того, вы можете написать программу обработки ошибок и указать ее в команде ON ERROR. Для определения причины, по которой не удалось записать данные в базу данных, вы можете использовать значения кодов ошибок. Для определения 
кодов ошибок используется функция ERROR ()   или AERROR () . 
</P>
<P>
При использовании буферизации данных в программе обработки ошибок вы можете определить, какие поля были изменены, каким было исходное значение поля и каким оно стало. Для определения изменения поля используется функция GETFLDSTATE (), которая по заданному номеру поля возвращает одно из значений, описанных в табл. 20.6. 
</P>
<P>
Таблица 20.6. Значения, возвращаемые функцией GETFLDSTATE ()</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Значение 
</TD>
<TD VALIGN="TOP">
Состояние 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
1 
</TD>
<TD VALIGN="TOP">
Значение поля не изменялось 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
2 
</TD>
<TD VALIGN="TOP">
Значение поля было изменено или поле было удалено 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
3 
</TD>
<TD VALIGN="TOP">
Значение поля во вновь добавленной записи не изменялось 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
4 
</TD>
<TD VALIGN="TOP">
Значение поля во вновь добавленной записи было изменено или поле было удалено 
</TD>
</TR>
</TABLE>
<p>&nbsp;
<a NAME="12"></a><font size="4">Использование транзакций </font> 
</P>
<P>
Под транзакцией в системах управления базами данных понимают логическую единицу работы, которая представляет собой последовательность нескольких операций, в процессе выполнения которых сохраняется целостное состояние базы данных. В процессе выполнения транзакции обновляемые данные временно хранятся в памяти или на локальном диске. Действительные изменения совершаются только после завершения транзакции. Если что-либо препятствует обновлению данных, все изменения отменяются и поэтому ваши данные остаются без изменения. 
</P>
<P>
Для управления транзакциями используется три команды, представленные в табл. 20.7. 
</P>
<P>
Таблица. 20.7. Команды, используемые для управления транзакциями 
</P>
<TABLE BORDER="1">
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
Команда 
</TD>
<TD VALIGN="TOP">
Назначение 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
BEGIN   TRANSACTION 
</TD>
<TD VALIGN="TOP">
Инициирует транзакцию 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
ROLLBACK 
</TD>
<TD VALIGN="TOP">
Осуществляет откат, т. е. аннулирует все выполненные в течение транзакции действия 
</TD>
</TR>
<TR ALIGN="LEFT" VALIGN="TOP">
<TD VALIGN="TOP">
END   TRANSACTION 
</TD>
<TD VALIGN="TOP">
Завершает транзакцию и сохраняет все выполненные действия в базе данных 
</TD>
</TR>
</TABLE>
<P>
В некоторых случаях вам может понадобиться использовать вложенные транзакции, при этом каждая из них должна начинаться командой BEGIN TRANSACTION и завершаться командой END TRANSACTION. Выполнение команды ROLLBACK действует только на транзакцию, внутри которой она выполняется. Команды BEGIN и END TRANSACTION могут находиться в разных функциях или процедурах. 
</P>
</BODY>
</HTML>